<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Extrasuri cont ING Homebank to structured data</title>
</head>

<body>
    <div id="wrapper">
        <div id="drop-area">
            <p>Drop Extras ING xls/x <br> <small>(or click to browse)</small></p>
            <input type="file" id="fileInput" class="hidden" accept=".xls,.xlsx" />
            <p id="file-name"></p> <!-- Element to display the file name -->
        </div>

        <div id="options">
            <select id="outputFormat">
                <option value="xlsx" selected>XLSX</option>
                <option value="csv">CSV</option>
                <option value="json">JSON</option>
            </select>
            <button id="convertButton">Convert</button>
        </div>

        <small id="credits"><a href="https://github.com/pax/ing-parser/">source</a></small>

    </div>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script> -->
    <script src="assets/xlsx.full.min.js"></script>
    <script>

availableFields = ["Tip tranzactie", "Autorizare", "Banca", "Beneficiar", "Data", "Data valutei", "Detalii", 
                        "Din contul", "In contul", "Nr. card", "Ordonator", "Rata", "Rata ING", "Referinta", 
                        "Suma", "Suma transmisa spre decontare", "Terminal", "Cod Fiscal Platitor", "Impozit pe dobanda"];

        document.getElementById('drop-area').addEventListener('click', () => document.getElementById('fileInput').click());
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('convertButton').addEventListener('click', processFile);

        // Add event listeners for drag and drop
        document.getElementById('drop-area').addEventListener('dragover', (event) => {
            event.stopPropagation();
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';
        });
        document.getElementById('drop-area').addEventListener('drop', (event) => {
            event.stopPropagation();
            event.preventDefault();
            handleFileSelect(event);
        });

        let selectedFile;

        function handleFileSelect(event) {
            // Check if files were dropped or selected via input
            selectedFile = (event.dataTransfer) ? event.dataTransfer.files[0] : event.target.files[0];
            document.getElementById('file-name').textContent = ' ' + selectedFile.name;
        }

        function processFile() {
            if (!selectedFile) {
                alert("Please select a file first!");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
                const data = event.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                // Data extraction logic
                const extractedData = extractData(jsonData);

                // Output format logic
                const outputFormat = document.getElementById('outputFormat').value;
                switch (outputFormat) {
                    case 'json':
                        downloadFile(JSON.stringify(extractedData), 'output.json', 'application/json');
                        break;
                    case 'csv':
                        const csvOutput = arrayToCSV(extractedData);
                        downloadFile(csvOutput, 'output.csv', 'text/csv');
                        break;
                    case 'xlsx':
                        const newWorkbook = XLSX.utils.book_new();
                        const newWorksheet = XLSX.utils.json_to_sheet(extractedData);
                        XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'Extracted Data');
                        XLSX.writeFile(newWorkbook, 'output.xlsx');
                        break;
                }
            };

            reader.readAsBinaryString(selectedFile);
        }

        function extractData(jsonData) {
            const tipTranzactie = ["Cumparare POS", "Incasare", "Retragere numerar", "Taxe si comisioane", "Transfer",
                "Transfer Home'Bank", "Depunere numerar", "Comision pe operatiune", "Schimb valutar",
                "Acoperire sold", "Plata poprire", "Centralizare solduri", "Actualizare dobanda"];

            return jsonData.map(row => {
              
                let extractedRow = {
            'Data': row['Data'],
            'Detalii tranzactie': row['Detalii tranzactie'],
            'Debit': row['Debit'],
            'Credit': row['Credit'],
            'Balanta': row['Balanta'],
            'Tip tranzactie': detectTransactionType(row['Detalii tranzactie'], tipTranzactie)
        };
                // // Process basic fields
                // extractedRow['Data'] = row['Data'];
                // extractedRow['Detalii tranzactie'] = row['Detalii tranzactie'];
                // extractedRow['Debit'] = row['Debit'];
                // extractedRow['Credit'] = row['Credit'];
                // extractedRow['Balanta'] = row['Balanta'];

                // Detect and set transaction type
                // let transactionType = tipTranzactie.find(tt => row['Detalii tranzactie'] && row['Detalii tranzactie'].startsWith(tt)) ||
                //     'NEW! ' + row['Detalii tranzactie'].split(' ').slice(0, 2).join(' ');
                // extractedRow['Tip tranzactie'] = transactionType;


                let details = row['Detalii tranzactie'] || '';
        availableFields.forEach(field => {
            extractedRow[field] = extractField(details, field);
        });

        return extractedRow;
                // Additional processing logic to extract other fields from 'Detalii tranzactie' and other columns
                // let details = row['Detalii tranzactie'] || '';

                // extractedRow['Detalii tranzactie'] = extractField(details, 'Detalii tranzactie');
                // extractedRow['Debit'] = extractField(details, 'Debit');
                // extractedRow['Credit'] = extractField(details, 'Credit');
                // extractedRow['Balanta'] = extractField(details, 'Balanta');
                // extractedRow['Tip tranzactie'] = extractField(details, 'Tip tranzactie');
                // extractedRow['Nr. card'] = extractField(details, 'Nr. card');
                // extractedRow['Terminal'] = extractField(details, 'Terminal');
                // extractedRow['Data_extracted'] = extractField(details, 'Data_extracted');
                // extractedRow['Autorizare'] = extractField(details, 'Autorizare');
                // extractedRow['Ordonator'] = extractField(details, 'Ordonator');
                // extractedRow['Din contul'] = extractField(details, 'Din contul');
                // extractedRow['Detalii'] = extractField(details, 'Detalii');
                // extractedRow['Referinta'] = extractField(details, 'Referinta');
                // extractedRow['Cod Fiscal Platitor'] = extractField(details, 'Cod Fiscal Platitor');
                // extractedRow['Suma'] = extractField(details, 'Suma');
                // extractedRow['Rata ING'] = extractField(details, 'Rata ING');
                // extractedRow['Suma transmisa spre decontare'] = extractField(details, 'Suma transmisa spre decontare');
                // extractedRow['Beneficiar'] = extractField(details, 'Beneficiar');
                // extractedRow['In contul'] = extractField(details, 'In contul');
                // extractedRow['Banca'] = extractField(details, 'Banca');
                // extractedRow['Rata'] = extractField(details, 'Rata');


                return extractedRow;
            });
        }
        function detectTransactionType(detailText, transactionTypes) {
    return transactionTypes.find(tt => detailText && detailText.startsWith(tt)) || 
           'NEW! ' + detailText.split(' ').slice(0, 2).join(' ');
}
        function extractField(detailText, fieldName) {
            let fieldRegex = new RegExp(fieldName + ':\\s*([^\\n]*)', 'i');
            let match = fieldRegex.exec(detailText);
            return match ? match[1].trim() : '';
        }


        function arrayToCSV(data) {
            const csvRows = [];
            const headers = Object.keys(data[0]);
            csvRows.push(headers.join(','));

            data.forEach(row => {
                const values = headers.map(header => JSON.stringify(row[header] || ''));
                csvRows.push(values.join(','));
            });

            return csvRows.join('\n');
        }

        function downloadFile(content, fileName, mimeType) {
            const a = document.createElement('a');
            const blob = new Blob([content], { type: mimeType });
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            a.click();
        }

    </script>
    <style>
        #drop-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 1.5em;
            cursor: pointer;
            background-color: white;
            border-radius: 5px;
            box-shadow: 2px 2px 2px rgba(255, 255, 224, 0.428);
        }

        small {
            color: #444;
        }

        #drop-area:hover {
            border: 2px dashed #CCF;
            background-color: rgba(255, 255, 224, 0.4);
        }

        .hidden {
            display: none;
        }

        #wrapper {
            margin: 2vw auto;
            max-width: 20em;
            width: 80vw;
        }

        #file-name:not(:empty) {
            font-family: monospace;
            background-color: lightyellow;
            padding: 0.5ex 0.75ex;
            border-radius: 4px;
            display: inline-block;
            border: 1px dashed #999;
        }

        body {
            font-family: sans-serif;
            background-color: whitesmoke;
        }

        #options {
            text-align: center;
        }

        #credits {
            position: absolute;
            right: .5em;
            display: inline-block;
            background-color: lightyellow;
            bottom: 1ex;
            padding: 1ex 1.25ex;
        }
    </style>
</body>

</html>